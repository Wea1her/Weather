---
import { cn } from '../../utils'

const { class: className } = Astro.props
---

<!-- 用于显示动态获取的引用/名言 -->

<quote-component class={cn('not-prose inline-block', className)}>
  <!-- 引用显示容器：圆角边框、阴影效果、横向布局 -->
  <div class='flex flex-row items-center gap-x-3 rounded-full border px-4 py-2 text-sm shadow-sm'>
    <!-- 动态指示器：带动画的绿色圆点 -->
    <span class='relative flex items-center justify-center'>
      <!-- 外层：ping 动画效果 -->
      <span
        class='absolute size-2 animate-ping rounded-full border border-green-400 bg-green-400 opacity-75'
      ></span>
      <!-- 内层：实心圆点 -->
      <span class='size-2 rounded-full bg-green-400'></span>
    </span>
    <!-- 引用文本显示区域，初始显示加载提示 -->
    <p id='quote-sentence' class='font-medium text-muted-foreground'>Loading...</p>
  </div>
</quote-component>

<script>
  // 导入配置文件
  import config from 'virtual:config'

  // 获取引用配置
  const { quote } = config.integ

  // 定义 Quote 自定义元素类
  class Quote extends HTMLElement {
    constructor() {
      super()
    }

    /**
     * 渲染引用文本到页面
     * @param sentence - 要显示的引用内容
     */
    render(sentence: string) {
      // 获取引用文本元素
      const quoteEl = this.querySelector('#quote-sentence') as HTMLElement
      if (!quoteEl) return
      // 更新文本内容
      quoteEl.innerText = sentence
    }

    /**
     * 组件挂载时的回调函数
     * 负责从服务器获取引用数据并渲染
     */
    connectedCallback() {
      // 因为 virtual:config 只能以 JSON 字符串形式访问，函数无法工作
      // 所以需要使用 new Function 动态创建处理函数
      const targetFunction = new Function('data', 'return (' + quote.target + ')(data)')
      // 从配置的服务器地址获取引用数据
      fetch(quote.server)
        .then((response) => response.json())
        .then((data) => this.render(targetFunction(data)))
    }
  }
  // 注册自定义元素
  customElements.define('quote-component', Quote)
</script>
