---
import { render, type CollectionEntry } from 'astro:content'
import bcryptjs from 'bcryptjs'
import CryptoJS from 'crypto-js'

import { getBlogCollection, sortMDByDate } from 'astro-pure/server'
import PostLayout from '@/layouts/BlogPost.astro'
import PasswordProtection from '@/components/PasswordProtection.astro'

export const prerender = true

export async function getStaticPaths() {
  const posts = sortMDByDate(await getBlogCollection())
  return posts.map((post) => ({
    params: { id: post.id },
    props: { post, posts }
  }))
}

type Props = {
  post: CollectionEntry<'blog'>
  posts: CollectionEntry<'blog'>[]
}

const { post, posts } = Astro.props
const { Content, headings, remarkPluginFrontmatter } = await render(post)

// 处理加密逻辑
let encryptedContent = ''
let passwordHash = ''
const isEncrypted = post.data.encrypted && post.data.password

if (isEncrypted) {
  // 获取原始 markdown 内容进行加密
  const contentToEncrypt = post.body ?? ''

  // 使用 AES 加密内容
  encryptedContent = CryptoJS.AES.encrypt(contentToEncrypt, post.data.password!).toString()

  // 生成密码哈希（用于验证）
  const saltRounds = 10
  passwordHash = bcryptjs.hashSync(post.data.password!, saltRounds)
}
---

{
  isEncrypted ? (
    <PostLayout {post} {posts} {headings} {remarkPluginFrontmatter}>
      <PasswordProtection {encryptedContent} {passwordHash} />
    </PostLayout>
  ) : (
    <PostLayout {post} {posts} {headings} {remarkPluginFrontmatter}>
      <Content />
    </PostLayout>
  )
}
